<html>
<head>
	<title id='title'>Download sif cards from schoolido.lu</title>
	<script src='jszip.min.js'></script>
	<script src='FileSaver.js'></script>
</head>
<body>
	<button id='buttno' onclick='downloadImages()'>Download</button>
	<br><br><br>
	<p id='counting'></p>
	<br>
	<p id='scanPrc'></p>
	<br>
	<div id='settings'>
		<p>Start at </p><input id="startAt" type='number' value='1'>
		<p>End At</p><input id="totalCards" type='number' value='2817'><br><br>
		<input type="checkbox" id="developer" name="developer" value="developer">
		<label for="developer">Developer Mode</label><br>
		<input type="checkbox" id="deepScan" name="deepScan" value="deepScan">
		<label for="deepScan">Don't use list of known cards (Not recommended)</label><br>
	</div><br>
	<button onclick='zipFile()' id='zippFilee' style='display:none'>Stop Downloading and zip (You will need to press when done. Auto download not supported yet.)</button>
	<br><br>
	<ul id='cards'></ul>
	<script>
		var cardList = document.getElementById('cards')
		var counting = document.getElementById('counting')
		var scanPrc = document.getElementById('scanPrc')
		var title = document.getElementById('title')
		fetch('knownCards.json').then( function(response) {
			if (response.status == 200) {
				response.blob().then( function(blob){
					var reader = new FileReader()
					reader.onload = function(e) {
						try {
							window.knownCards = JSON.parse(e.target.result)
						} catch(e) {
							var p = document.createElement('h1')
							p.innerHTML = 'Json Parse Error of cards list'
							cardList.appendChild(p)
							document.getElementById('settings').style = 'display:none'
							document.getElementById('buttno').remove()
						}
					}
					reader.readAsText(blob)
				})
			}
		})
		function zipFile() {
			document.getElementById('zippFilee').style = 'display:none'
			window.download = false
			if (document.getElementById('developer').checked) {
				var p = document.createElement('li')
				var blob = new Blob([JSON.stringify(this.cards)], {type : 'application/json'})
				p.innerHTML = '<a href="'+URL.createObjectURL(blob)+'" target="_blank">card list</a>'
				cardList.appendChild(p)
			}
			scanPrc.innerHTML = 'Generating Zip'
			zip.generateAsync({type:"blob"}).then(function(content) {
				saveAs(content, "Anime Cards.zip")
				scanPrc.innerHTML = 'zip file downloaded'
			})	
		}
	function downloadImages(name) {
		var knownCards = window.knownCards
		var totalCards = 2817
		if (document.getElementById('totalCards').value && document.getElementById('totalCards').value != '') {
			var totalCards = document.getElementById('totalCards').value
		}
		var chars = [
					 {
						"name": "idolizedEli"
					 },
					 {
						"name": "Eli"
					 },
					 {
						"name": "idolizedHanayo"
					 },
					 {
						"name": "Hanayo"
					 },
					 {
						"name": "idolizedHonoka"
					 },
					 {
						"name": "Honoka"
					 },
					 {
						"name": "idolizedKotori"
					 },
					 {
						"name": "Kotori"
					 },
					 {
						"name": "idolizedMaki"
					 },
					 {
						"name": "Maki"
					 },
					 {
						"name": "idolizedNico"
					 },
					 {
						"name": "Nico"
					 },
					 {
						"name": "idolizedNozomi"
					 },
					 {
						"name": "Nozomi"
					 },
					 {
						"name": "idolizedRin"
					 },
					 {
						"name": "Rin"
					 },
					 {
						"name": "idolizedUmi"
					 },
					 {
						"name": "Umi"
					 },
					 {
						"name": "idolizedChika"
					 },
					 {
						"name": "Chika"
					 },
					 {
						"name": "idolizedHanamaru"
					 },
					 {
						"name": "Hanamaru"
					 },
					 {
						"name": "idolizedDia"
					 },
					 {
						"name": "Dia"
					 },
					 {
						"name": "idolizedKanan"
					 },
					 {
						"name": "Kanan"
					 },
					 {
						"name": "idolizedMari"
					 },
					 {
						"name": "Mari"
					 },
					 {
						"name": "idolizedRiko"
					 },
					 {
						"name": "Riko"
					 },
					 {
						"name": "idolizedRuby"
					 },
					 {
						"name": "Ruby"
					 },
					 {
						"name": "idolizedYoshiko"
					 },
					 {
						"name": "Yoshiko"
					 },
					 {
						"name": "idolizedYou"
					 },
					 {
						"name": "You"
					 }
					]
			// need to add Nijigasaki
		//console.log(chars.length)
		//return
		var m = new JSZip()
		window.zip = m
		var cardList = document.getElementById('cards')
		var counting = document.getElementById('counting')
		var scanPrc = document.getElementById('scanPrc')
		var title = document.getElementById('title')
		document.getElementById('settings').style = 'display:none'
		document.getElementById('zippFilee').style = 'display:block'
		document.getElementById('buttno').remove()
		while (document.getElementById('cards').firstChild) {
			document.getElementById('cards').removeChild(document.getElementById('cards').firstChild);
		}
		function Download(name, t) {
				var i=0
				if (document.getElementById('startAt').value) {
					var i = document.getElementById('startAt').value
				}
				function checkSend() {
					if (! download) {
						return
					}
					if (knownCards[name].includes(i) || document.getElementById('deepScan').checked) {
						fetch('https://i.schoolido.lu/c/'+i+name+'.png').then(response => {
							if (response.status == 200) {
								response.blob().then(blob => {
									var p = document.createElement('li')
									p.innerHTML = '<a href="'+URL.createObjectURL(blob)+'" target="_blank">'+i+name+'.png</a>'
									cardList.appendChild(p)
									this.cards[name].push(i)
									t.file(i+name+'.png', blob);
									if (i != totalCards) {
										i++
										checkSend()
									} else {
										this.finished++
										scanPrc.innerHTML = this.finished+'/'+this.chars.length+' downloaded. Once everything is completed, click the zip button'
									}
								})
								this.o++
								counting.innerHTML = 'Amount Downloaded: '+this.o
								title.innerHTML = 'Amount Downloaded: '+this.o
							} else {
								if (i != totalCards) {
									i++
									checkSend()
								} else {
									this.finished++
									scanPrc.innerHTML = this.finished+'/'+this.chars.length+' downloaded. Once everything is completed, click the zip button'
								}
							}
						})
					} else {
						if (i != totalCards) {
							i++
							checkSend()
						} else {
							this.finished++
							scanPrc.innerHTML = this.finished+'/'+this.chars.length+' downloaded. Once everything is completed, click the zip button'
						}
					}
				}
				i++
				checkSend()
		}
		this.cards = { }
		this.chars = chars
		this.o = 0
		window.download = true
		this.finished = 0
		this.amountDone = 0
		for (var t=0; t<chars.length; t++) {
			this.cards[chars[t].name] = [ ]
			if (chars[t].name.substring(0, 8) == 'idolized') {
				var a = chars[t].name.substring(8, chars[t].name.length)
			} else {
				var a = chars[t].name
			}
			var folder = zip.folder(a)
			Download(chars[t].name, folder)
		}
	}
	</script>
</body>
</html>
