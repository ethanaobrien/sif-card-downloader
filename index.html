<html>
<head>
	<title id='title'>Download sif cards from schoolido.lu</title>
	<script src='jszip.min.js'></script>
	<script src='FileSaver.js'></script>
</head>
<body>
	<button id='buttno' onclick='downloadImages()'>Download</button>
	<br><br><br>
	<p id='counting'></p>
	<br>
	<p id='scanPrc'></p>
    <br><br>
        <div id='downloadSelect' style='display:none'>
            <div id='Muse'>
                <input type="checkbox" id="Honoka" name="Honoka" value="Honoka">
                <label for="Honoka">Honoka Kosaka</label><br>
                <input type="checkbox" id="Eli" name="Eli" value="Eli">
                <label for="Eli">Eli Ayase</label><br>
                <input type="checkbox" id="Kotori" name="Kotori" value="Kotori">
                <label for="Kotori">Kotori Minami</label><br>
                <input type="checkbox" id="Umi" name="Umi" value="Umi">
                <label for="Umi">Umi Sonoda</label><br>
                <input type="checkbox" id="Rin" name="Rin" value="Rin">
                <label for="Rin">Rin Hoshizora</label><br>
                <input type="checkbox" id="Maki" name="Maki" value="Maki">
                <label for="Maki">Maki Nishikino</label><br>
                <input type="checkbox" id="Nozomi" name="Nozomi" value="Nozomi">
                <label for="Nozomi">Nozomi Tojo</label><br>
                <input type="checkbox" id="Hanayo" name="Hanayo" value="Hanayo">
                <label for="Hanayo">Hanayo Koizumi</label><br>
                <input type="checkbox" id="Nico" name="Nico" value="Nico">
                <label for="Nico">Nico Yazawa</label><br>
            </div>
            <div id='Aqours'>
                <input type="checkbox" id="Chika" name="Chika" value="Chika">
                <label for="Chika">Chika Takami</label><br>
                <input type="checkbox" id="Riko" name="Riko" value="Riko">
                <label for="Riko">Riko Sakurauchi</label><br>
                <input type="checkbox" id="Kanan" name="Kanan" value="Kanan">
                <label for="Kanan">Kanan Matsuura</label><br>
                <input type="checkbox" id="Dia" name="Dia" value="Dia">
                <label for="Dia">Dia Kurosawa</label><br>
                <input type="checkbox" id="You" name="You" value="You">
                <label for="You">You Watanabe</label><br>
                <input type="checkbox" id="Yoshiko" name="Yoshiko" value="Yoshiko">
                <label for="Yoshiko">Yoshiko Tsushima</label><br>
                <input type="checkbox" id="Hanamaru" name="Hanamaru" value="Hanamaru">
                <label for="Hanamaru">Hanamaru Kunikida</label><br>
                <input type="checkbox" id="Mari" name="Mari" value="Mari">
                <label for="Mari">Mari Ohara</label><br>
                <input type="checkbox" id="Ruby" name="Ruby" value="Ruby">
                <label for="Ruby">Ruby Kurosawa</label><br>
            </div>
            <div id='Nijigasaki'>
                <input type="checkbox" id="Ayumu" name="Ayumu" value="Ayumu">
                <label for="Ayumu">Ayumu Uehara</label><br>
                <input type="checkbox" id="Kasumi" name="Kasumi" value="Kasumi">
                <label for="Kasumi">Kasumi Nakasu</label><br>
                <input type="checkbox" id="Shizuku" name="Shizuku" value="Shizuku">
                <label for="Shizuku">Shizuku Osaka</label><br>
                <input type="checkbox" id="Karin" name="Karin" value="Karin">
                <label for="Karin">Karin Asaka</label><br>
                <input type="checkbox" id="Ai" name="Ai" value="Ai">
                <label for="Ai">Ai Miyashita</label><br>
                <input type="checkbox" id="Kanata" name="Kanata" value="Kanata">
                <label for="Kanata">Kanata Konoe</label><br>
                <input type="checkbox" id="Setsuna" name="Setsuna" value="Setsuna">
                <label for="Setsuna">Setsuna Yuki</label><br>
                <input type="checkbox" id="Emma" name="Emma" value="Emma">
                <label for="Emma">Emma Verde</label><br>
                <input type="checkbox" id="Rina" name="Rina" value="Rina">
                <label for="Rina">Rina Tennoji</label><br>
            </div>
        </div>
        <input type="checkbox" id="downloadAll" name="downloadAll" value="downloadAll" onchange='cardsVisibility()'>
        <label for="downloadAll">Download All</label><br>
	<br>
	<div id='settings'>
		<p>Start at </p><input id="startAt" type='number' value='0'>
		<p>End At</p><input id="totalCards" type='number' value='2817'><br><br>
		<input type="checkbox" id="developer" name="developer" value="developer">
		<label for="developer">Developer Mode</label><br>
		<input type="checkbox" id="deepScan" name="deepScan" value="deepScan">
		<label for="deepScan">Don't use list of known cards (Not recommended)</label><br>
	</div><br>
	<button onclick='zipFile()' id='zippFilee' style='display:none'>Stop Downloading and zip</button>
	<br><br>
	<ul id='cards'></ul>
	<script>
        document.getElementById('downloadAll').checked = true
		var cardList = document.getElementById('cards')
		var counting = document.getElementById('counting')
		var scanPrc = document.getElementById('scanPrc')
		var title = document.getElementById('title')
		fetch('knownCards.json').then( function(response) {
			if (response.status == 200) {
				response.blob().then( function(blob){
					var reader = new FileReader()
					reader.onload = function(e) {
						try {
							window.knownCards = JSON.parse(e.target.result)
						} catch(e) {
							var p = document.createElement('h1')
							p.innerHTML = 'Json Parse Error of cards list'
							cardList.appendChild(p)
							document.getElementById('settings').style = 'display:none'
							document.getElementById('buttno').remove()
						}
					}
					reader.readAsText(blob)
				})
			}
		})
        function cardsVisibility() {
            var cardsDiv = document.getElementById('downloadSelect')
            var downloadAll = document.getElementById('downloadAll')
            if (downloadAll.checked) {
                cardsDiv.style = 'display:none'
            } else {
                cardsDiv.style = 'display:block'
            }
        }
		function zipFile() {
			document.getElementById('zippFilee').style = 'display:none'
			window.download = false
			if (document.getElementById('developer').checked) {
				var p = document.createElement('li')
				var blob = new Blob([JSON.stringify(cards)], {type : 'application/json'})
				p.innerHTML = '<a href="'+URL.createObjectURL(blob)+'" target="_blank">card list</a>'
				cardList.appendChild(p)
			}
			scanPrc.innerHTML = 'Generating Zip'
			zip.generateAsync({type:"blob"}, function updateCallback(metadata) {
				scanPrc.innerHTML = "Zipping File: " + metadata.percent.toFixed(2) + " %"
			}).then(function(content) {
				saveAs(content, "Anime Cards.zip")
				scanPrc.innerHTML = 'zip file downloaded'
			})
		}
	function downloadImages(name) {
		var totalCards = 2817
		if (document.getElementById('totalCards').value && document.getElementById('totalCards').value != '') {
			var totalCards = document.getElementById('totalCards').value
		}
		window.chars = [
						["idolizedEli", "Muse"],
						["Eli", "Muse"],
						["idolizedHanayo", "Muse"],
						["Hanayo", "Muse"],
						["idolizedHonoka", "Muse"],
						["Honoka", "Muse"],
						["idolizedKotori", "Muse"],
						["Kotori", "Muse"],
						["idolizedMaki", "Muse"],
						["Maki", "Muse"],
						["idolizedNico", "Muse"],
						["Nico", "Muse"],
						["idolizedNozomi", "Muse"],
						["Nozomi", "Muse"],
						["idolizedRin", "Muse"],
						["Rin", "Muse"],
						["idolizedUmi", "Muse"],
						["Umi", "Muse"],
						["idolizedChika", "Aqours"],
						["Chika", "Aqours"],
						["idolizedHanamaru", "Aqours"],
						["Hanamaru", "Aqours"],
						["idolizedDia", "Aqours"],
						["Dia", "Aqours"],
						["idolizedKanan", "Aqours"],
						["Kanan", "Aqours"],
						["idolizedMari", "Aqours"],
						["Mari", "Aqours"],
						["idolizedRiko", "Aqours"],
						["Riko", "Aqours"],
						["idolizedRuby", "Aqours"],
						["Ruby", "Aqours"],
						["idolizedYoshiko", "Aqours"],
						["Yoshiko", "Aqours"],
						["idolizedYou", "Aqours"],
						["You", "Aqours"],
						["idolizedAi", "Nijigasaki"],
						["Ai", "Nijigasaki"],
						["idolizedAyumu", "Nijigasaki"],
						["Ayumu", "Nijigasaki"],
						["idolizedEmma", "Nijigasaki"],
						["Emma", "Nijigasaki"],
						["idolizedKanata", "Nijigasaki"],
						["Kanata", "Nijigasaki"],
						["idolizedKarin", "Nijigasaki"],
						["Karin", "Nijigasaki"],
						["idolizedKasumi", "Nijigasaki"],
						["Kasumi", "Nijigasaki"],
						["idolizedRina", "Nijigasaki"],
						["Rina", "Nijigasaki"],
						["idolizedSetsuna", "Nijigasaki"],
						["Setsuna", "Nijigasaki"],
						["idolizedShizuku", "Nijigasaki"],
						["Shizuku", "Nijigasaki"]
					]
        window.characterAmount = chars.length
		var m = new JSZip()
		window.zip = m
		var cardList = document.getElementById('cards')
		var counting = document.getElementById('counting')
		var scanPrc = document.getElementById('scanPrc')
		var title = document.getElementById('title')
		document.getElementById('settings').style = 'display:none'
		document.getElementById('zippFilee').style = 'display:block'
		document.getElementById('buttno').remove()
		while (document.getElementById('cards').firstChild) {
			document.getElementById('cards').removeChild(document.getElementById('cards').firstChild);
		}
		function Download(name, t) {
				var i=0
				if (document.getElementById('startAt').value) {
					var i = document.getElementById('startAt').value
				}
				function checkSend() {
					if (! download) {
						return
					}
					if (knownCards[name].includes(i) || document.getElementById('deepScan').checked) {
						fetch('https://i.schoolido.lu/c/'+i+name+'.png').then(response => {
							if (response.status == 200) {
								response.blob().then(blob => {
									var p = document.createElement('li')
									p.innerHTML = '<a href="'+URL.createObjectURL(blob)+'" target="_blank">'+i+name+'.png</a>'
									cardList.appendChild(p)
									cards[name].push(i)
									t.file(i+name+'.png', blob);
									if (i != totalCards) {
										i++
										checkSend()
									} else {
										finished++
										scanPrc.innerHTML = finished+'/'+characterAmount+' downloaded.'
										if (finished == characterAmount) {
											zipFile()
										}
									}
								})
								o++
								counting.innerHTML = 'Amount Downloaded: '+o
								title.innerHTML = 'Amount Downloaded: '+o
							} else {
								if (i != totalCards) {
									i++
									checkSend()
								} else {
									finished++
									scanPrc.innerHTML = finished+'/'+characterAmount+' downloaded.'
								if (finished == characterAmount) {
									zipFile()
								}
								}
							}
						})
					} else {
						if (i != totalCards) {
							i++
							checkSend()
						} else {
							finished++
							scanPrc.innerHTML = finished+'/'+characterAmount+' downloaded.'
							if (finished == characterAmount) {
								zipFile()
							}
						}
					}
				}
				i++
				checkSend()
		}
		window.cards = { }
		window.o = 0
		window.download = true
		window.finished = 0
        if (! document.getElementById("downloadAll").checked) {
            window.characterAmount = 0
        }
		for (var t=0; t<chars.length; t++) {
			cards[chars[t][0]] = [ ]
			if (chars[t][0].substring(0, 8) == 'idolized') {
				var idolName = chars[t][0].substring(8, chars[t][0].length)
			} else {
				var idolName = chars[t][0]
			}
            if (document.getElementById(idolName).checked || document.getElementById("downloadAll").checked) {
                var groupFolder = zip.folder(chars[t][1])
                var folder = groupFolder.folder(idolName)
                Download(chars[t][0], folder)
                if (! document.getElementById("downloadAll").checked) {
                    characterAmount++
                }
            }
		}
	}
	</script>
</body>
</html>
