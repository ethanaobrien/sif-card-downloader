<html>
<head>
    <title id='title'>Download sif cards from schoolido.lu</title>
    <script src='jszip.min.js'></script>
    <script src='FileSaver.js'></script>
</head>
<body>
    <button id='buttno' onclick='downloadImages()'>Download</button>
    <br>
    <p id='counting'></p>
    <br>
    <p id='scanPrc'></p>
    <br>
    <div id='settings'>
        <input type="checkbox" id="downloadAll" name="downloadAll" value="downloadAll" onchange='cardsVisibility()' checked>
        <label for="downloadAll">Download All</label><br><br>
        <div id='downloadSelect' style='display:none;'>
            <input type="checkbox" id="noDownloadOther" name="noDownloadOther" value="noDownloadOther">
            <label for="noDownloadOther">Download All, except other</label><br><br>
            <div id='Muse' style="float:left; width:25%;">
                <input type="checkbox" id="Honoka" name="Honoka" value="Honoka">
                <label for="Honoka">Honoka Kosaka</label><br>
                <input type="checkbox" id="Eli" name="Eli" value="Eli">
                <label for="Eli">Eli Ayase</label><br>
                <input type="checkbox" id="Kotori" name="Kotori" value="Kotori">
                <label for="Kotori">Kotori Minami</label><br>
                <input type="checkbox" id="Umi" name="Umi" value="Umi">
                <label for="Umi">Umi Sonoda</label><br>
                <input type="checkbox" id="Rin" name="Rin" value="Rin">
                <label for="Rin">Rin Hoshizora</label><br>
                <input type="checkbox" id="Maki" name="Maki" value="Maki">
                <label for="Maki">Maki Nishikino</label><br>
                <input type="checkbox" id="Nozomi" name="Nozomi" value="Nozomi">
                <label for="Nozomi">Nozomi Tojo</label><br>
                <input type="checkbox" id="Hanayo" name="Hanayo" value="Hanayo">
                <label for="Hanayo">Hanayo Koizumi</label><br>
                <input type="checkbox" id="Nico" name="Nico" value="Nico">
                <label for="Nico">Nico Yazawa</label><br>
                <br>
            </div>
            <div id='Aqours' style="float:left; width:25%;">
                <input type="checkbox" id="Chika" name="Chika" value="Chika">
                <label for="Chika">Chika Takami</label><br>
                <input type="checkbox" id="Riko" name="Riko" value="Riko">
                <label for="Riko">Riko Sakurauchi</label><br>
                <input type="checkbox" id="Kanan" name="Kanan" value="Kanan">
                <label for="Kanan">Kanan Matsuura</label><br>
                <input type="checkbox" id="Dia" name="Dia" value="Dia">
                <label for="Dia">Dia Kurosawa</label><br>
                <input type="checkbox" id="You" name="You" value="You">
                <label for="You">You Watanabe</label><br>
                <input type="checkbox" id="Yoshiko" name="Yoshiko" value="Yoshiko">
                <label for="Yoshiko">Yoshiko Tsushima</label><br>
                <input type="checkbox" id="Hanamaru" name="Hanamaru" value="Hanamaru">
                <label for="Hanamaru">Hanamaru Kunikida</label><br>
                <input type="checkbox" id="Mari" name="Mari" value="Mari">
                <label for="Mari">Mari Ohara</label><br>
                <input type="checkbox" id="Ruby" name="Ruby" value="Ruby">
                <label for="Ruby">Ruby Kurosawa</label><br>
                <br>
            </div>
            <div id='Nijigasaki' style="float:left; width:25%;">
                <input type="checkbox" id="Ayumu" name="Ayumu" value="Ayumu">
                <label for="Ayumu">Ayumu Uehara</label><br>
                <input type="checkbox" id="Kasumi" name="Kasumi" value="Kasumi">
                <label for="Kasumi">Kasumi Nakasu</label><br>
                <input type="checkbox" id="Shizuku" name="Shizuku" value="Shizuku">
                <label for="Shizuku">Shizuku Osaka</label><br>
                <input type="checkbox" id="Karin" name="Karin" value="Karin">
                <label for="Karin">Karin Asaka</label><br>
                <input type="checkbox" id="Ai" name="Ai" value="Ai">
                <label for="Ai">Ai Miyashita</label><br>
                <input type="checkbox" id="Kanata" name="Kanata" value="Kanata">
                <label for="Kanata">Kanata Konoe</label><br>
                <input type="checkbox" id="Setsuna" name="Setsuna" value="Setsuna">
                <label for="Setsuna">Setsuna Yuki</label><br>
                <input type="checkbox" id="Emma" name="Emma" value="Emma">
                <label for="Emma">Emma Verde</label><br>
                <input type="checkbox" id="Rina" name="Rina" value="Rina">
                <label for="Rina">Rina Tennoji</label><br>
                <br>
            </div>
            <div id='whitespace' style="float:left; width:25%;">
                <input type="checkbox" id="otherIdols" name="otherIdols" value="otherIdols">
                <label for="otherIdols">Other Idols/Cards</label><br>
                <br><br><br><br><br><br><br><br><br><br>
            </div>
        </div>
        <input type="checkbox" id="Transparent" name="Transparent" value="Transparent">
        <label for="Transparent">Transparent Cards</label><br>
        <br><br>
        <p>Start at </p><input id="startAt" type='number' value='0'>
        <p>End At</p><input id="totalCards" type='number' value='2839'><br><br>
        <input type="checkbox" id="displayLinks" name="displayLinks" value="displayLinks" checked>
        <label for="displayLinks">Display filenames/links while downloading</label><br><br>
        <input type="checkbox" id="convertFiles" name="convertFiles" value="convertFiles" onchange='convertVisibility()'>
        <label for="convertFiles">Convert files from png to jpg (cpu and memory may increase)</label><br><br>
        <div id='jpgsettings' style='display:none;'><ul><p>Quality. 0 - 100</p><input id="jpgQuality" type='number' value='92'><br><br></ul></div>
        <input type="checkbox" id="downloadZip" name="downloadZip" value="downloadZip" checked>
        <label for="downloadZip">Download as zip</label><br><br>
        <p>Zip Filename</p>
        <input type='text' value='Anime Cards' id='zipFilename'>
        <br><br><br>
        <input type="checkbox" id="developer" name="developer" value="developer" onchange='developerVisibility()'>
        <label for="developer">Developer Mode</label><br>
        <div id='developerMode' style='display:none;'>
            <ul>
            <p>Developer Mode May break auto zip. You may need to manually click the zip button when completed</p>
            <input type="checkbox" id="deepScan" name="deepScan" value="deepScan">
            <label for="deepScan">Don't use list of known cards (Not recommended)</label><br>
            <input type="checkbox" id="onlyDownloadUnknown" name="onlyDownloadUnknown" value="onlyDownloadUnknown">
            <label for="onlyDownloadUnknown">Only download unknown cards</label><br>
            <input type="checkbox" id="findUnknownCards" name="findUnknownCards" value="findUnknownCards">
            <label for="findUnknownCards">Find unknown cards</label><br>
            <br>
            <p id='customCardMessage'>custom card list (to build onto)</p>
            <input id='customCardsList' type='file' onchange='customCardList()'><br>
            <p id='cardsToScanMessage'>Custom Card list (to scan)</p>
            <input id='cardsToScan' type='file' onchange='cardsToScanList()'>
            </ul>
        </div>
        <br>
        <input type="checkbox" id="non-idolized" name="non-idolized" value="non-idolized" checked>
        <label for="non-idolized">Non Idolized</label><br>
        <input type="checkbox" id="idolized" name="idolized" value="idolized" checked>
        <label for="idolized">Idolized</label><br>
        <br>
        <p>To View More Card Details, Visit <a href='https://schoolido.lu/cards/' target="_blank">schoolidol.lu/cards/</a></p>
    </div><br>
    <button onclick='zipFile()' id='zippFilee' style='display:none'>Stop Downloading and zip</button>
    <button onclick='stopDownload()' id='stoppDownload' style='display:none'>Stop Downloading</button>
    <br><br>
    <ul id='cards'></ul>
    <script>
        var cardList = document.getElementById('cards')
        var counting = document.getElementById('counting')
        var scanPrc = document.getElementById('scanPrc')
        var title = document.getElementById('title')
        fetch('knownCards.json').then( function(response) {
            if (response.status == 200) {
                response.blob().then( function(blob){
                    var reader = new FileReader()
                    reader.onload = function(e) {
                        try {
                            window.knownCards = JSON.parse(e.target.result)
                        } catch(e) {
                            var p = document.createElement('h1')
                            p.innerHTML = 'Json Parse Error of cards list'
                            cardList.appendChild(p)
                            document.getElementById('settings').style = 'display:none'
                            document.getElementById('buttno').remove()
                        }
                    }
                    reader.readAsText(blob)
                })
            } else {
                var p = document.createElement('h1')
                p.innerHTML = 'Failed to fetch knownCards.json'
                cardList.appendChild(p)
                document.getElementById('settings').style = 'display:none'
                document.getElementById('buttno').remove()
            }
        })
        fetch('idols.json').then( function(response) {
            if (response.status == 200) {
                response.blob().then( function(blob){
                    var reader = new FileReader()
                    reader.onload = function(e) {
                        try {
                            window.chars = JSON.parse(e.target.result)
                        } catch(e) {
                            var p = document.createElement('h1')
                            p.innerHTML = 'Json Parse Error of Idols list'
                            cardList.appendChild(p)
                            document.getElementById('settings').style = 'display:none'
                            document.getElementById('buttno').remove()
                        }
                    }
                    reader.readAsText(blob)
                })
            } else {
                var p = document.createElement('h1')
                p.innerHTML = 'Failed to fetch idols.json'
                cardList.appendChild(p)
                document.getElementById('settings').style = 'display:none'
                document.getElementById('buttno').remove()
            }
        })
        function customCardList() {
            var file = document.getElementById('customCardsList').files[0]
            var reader = new FileReader()
            reader.onload = function(e){
                try {
                    var data = JSON.parse(e.target.result)
                } catch(e) {
                    alert('File is not a json array')
                    return
                }
                window.cards = data
                document.getElementById('customCardMessage').remove()
                document.getElementById('customCardsList').remove()
                alert('Successfully set cards list')
            }
            reader.readAsText(file)
        }
        function cardsToScanList() {
            var file = document.getElementById('cardsToScan').files[0]
            var reader = new FileReader()
            reader.onload = function(e){
                try {
                    var data = JSON.parse(e.target.result)
                } catch(e) {
                    alert('File is not a json array')
                    return
                }
                window.knownCards = data
                document.getElementById('cardsToScanMessage').remove()
                document.getElementById('cardsToScan').remove()
                alert('Successfully set cards list')
            }
            reader.readAsText(file)
        }
        function developerVisibility() {
            var div = document.getElementById('developerMode')
            var check = document.getElementById('developer').checked
            if (check) {
                div.style = 'display:block;'
            } else {
                div.style = 'display:none;'
            }
        }
        function cardsVisibility() {
            var cardsDiv = document.getElementById('downloadSelect')
            var downloadAll = document.getElementById('downloadAll').checked
            if (downloadAll) {
                cardsDiv.style = 'display:none;'
            } else {
                cardsDiv.style = 'display:block; width:100%'
            }
        }
        function convertVisibility() {
            var a = document.getElementById('jpgsettings')
            var b = document.getElementById('convertFiles').checked
            if (b) {
                a.style = 'display:block;'
            } else {
                a.style = 'display:none;'
            }
        }
        function stopDownload() {
            document.getElementById('stoppDownload').style = 'display:none'
            window.download = false
            if (document.getElementById('developer').checked) {
                var p = document.createElement('li')
                var blob = new Blob([JSON.stringify(cards, null, 2)], {type : 'application/json'})
                p.innerHTML = '<a href="'+URL.createObjectURL(blob)+'" target="_blank">card list</a>'
                cardList.appendChild(p)
            }
        }
        function zipFile() {
            document.getElementById('zippFilee').style = 'display:none'
            if (document.getElementById('developer').checked) {
                var p = document.createElement('li')
                var blob = new Blob([JSON.stringify(cards, null, 2)], {type : 'application/json'})
                p.innerHTML = '<a href="'+URL.createObjectURL(blob)+'" target="_blank">card list</a>'
                cardList.appendChild(p)
            }
            scanPrc.innerHTML = 'Generating Zip'
            zip.generateAsync({type:"blob"}, function updateCallback(metadata) {
                scanPrc.innerHTML = "Zipping File: " + metadata.percent.toFixed(2) + " %"
            }).then(function(content) {
                var name = document.getElementById('zipFilename').value
                saveAs(content, name+".zip")
                scanPrc.innerHTML = 'zip file downloaded'
                window.download = false
            })
        }
    function downloadImages() {
        if (! document.getElementById('zipFilename').value || document.getElementById('zipFilename').value.replace(' ', '') == '') {
            alert('Please input zip filename')
            window.location.reload()
        }
        if (! chars || ! knownCards) {
            var p = document.createElement('h1')
            p.innerHTML = 'Missing knownCards or Idol character list'
            cardList.appendChild(p)
            document.getElementById('settings').style = 'display:none'
            document.getElementById('buttno').remove()
            
        }
        if (document.getElementById('downloadAll').checked) {
            document.getElementById('noDownloadOther').checked = false
        }
        window.totalCards = 2839
        if (document.getElementById('totalCards').value && document.getElementById('totalCards').value != '') {
            var totalCards = document.getElementById('totalCards').value
        }
        window.characterAmount = chars.length
        if (document.getElementById('downloadZip').checked) {
            var m = new JSZip()
            window.zip = m
            document.getElementById('zippFilee').style = 'display:block'
        } else {
            document.getElementById('stoppDownload').style = 'display:block'
        }
        var cardList = document.getElementById('cards')
        var counting = document.getElementById('counting')
        var scanPrc = document.getElementById('scanPrc')
        var title = document.getElementById('title')
        document.getElementById('settings').style = 'display:none'
        document.getElementById('buttno').remove()
        while (document.getElementById('cards').firstChild) {
            document.getElementById('cards').removeChild(document.getElementById('cards').firstChild);
        }
        function startDownload(name, t) {
                var i=0
                if (document.getElementById('startAt').value) {
                    var i = document.getElementById('startAt').value
                }
                if (! knownCards[name]) {
                    knownCards[name] = [ ]
                }
                function convertImg(blob, callback) {
                    var image = document.createElement('img')
                    image.src = URL.createObjectURL(blob)
                    image.onload = function() {
                        var canvas = document.createElement('canvas')
                        canvas.width = image.width
                        canvas.height = image.height
                        canvas.getContext("2d").drawImage(image, 0, 0)
                        var quality = document.getElementById('jpgQuality').value
                        if (quality.value != '') {
                            var quality = quality.value / 100
                        } else {
                            var quality = '0.92'
                        }
                        canvas.toBlob(callback, 'image/jpeg', quality)
                    }
                }
                function checkSend() {
                    if (! window.download) {
                        return
                    }
                    if (knownCards[name].includes(i) || document.getElementById('deepScan').checked) {
                        if (name == 'Transparent' || name == 'idolizedTransparent') {
                            var cardLocation = 'https://i.schoolido.lu/cards/transparent/'+i+name+'.png'
                        } else {
                            var cardLocation = 'https://i.schoolido.lu/c/'+i+name+'.png'
                        }
                        fetch(cardLocation).then(response => {
                            if (response.status == 200) {
                                response.blob().then(blob => {
                                    if (! cards[name].includes(i)) {
                                        cards[name].push(i)
                                    }
                                    if (! document.getElementById('convertFiles').checked) {
                                        if (document.getElementById('displayLinks').checked) {
                                            var p = document.createElement('li')
                                            p.innerHTML = '<a href="'+URL.createObjectURL(blob)+'" target="_blank">'+i+name+'.png</a>'
                                            cardList.appendChild(p)
                                        }
                                        if (document.getElementById('downloadZip').checked) {
                                            t.file(i+name+'.png', blob);
                                        }
                                        if (i != totalCards) {
                                            i++
                                            checkSend()
                                        } else {
                                            window.finished++
                                            scanPrc.innerHTML = finished+'/'+characterAmount+' idols downloaded.'
                                            if (finished == characterAmount && document.getElementById('downloadZip').checked) {
                                                zipFile()
                                            }
                                        }
                                    } else {
                                        convertImg(blob, function(blob) {
                                            if (document.getElementById('displayLinks').checked) {
                                                var p = document.createElement('li')
                                                p.innerHTML = '<a href="'+URL.createObjectURL(blob)+'" target="_blank">'+i+name+'.jpg</a>'
                                                cardList.appendChild(p)
                                            }
                                            if (document.getElementById('downloadZip').checked) {
                                                t.file(i+name+'.jpg', blob);
                                            }
                                            if (i != totalCards) {
                                                i++
                                                checkSend()
                                            } else {
                                                window.finished++
                                                scanPrc.innerHTML = finished+'/'+characterAmount+' idols downloaded.'
                                                if (finished == characterAmount && document.getElementById('downloadZip').checked) {
                                                    zipFile()
                                                }
                                            }    
                                        })
                                    }
                                })
                                o++
                                counting.innerHTML = 'Amount Downloaded: '+o
                                title.innerHTML = 'Amount Downloaded: '+o
                            } else {
                                if (i != totalCards) {
                                    i++
                                    checkSend()
                                } else {
                                    window.finished++
                                    scanPrc.innerHTML = finished+'/'+characterAmount+' idols downloaded.'
                                    if (finished == characterAmount && document.getElementById('downloadZip').checked) {
                                        zipFile()
                                    }
                                }
                            }
                        })
                    } else {
                        if (i != totalCards) {
                            i++
                            checkSend()
                        } else {
                            window.finished++
                            scanPrc.innerHTML = finished+'/'+characterAmount+' idols downloaded.'
                            if (finished == characterAmount && document.getElementById('downloadZip').checked) {
                                zipFile()
                            }
                        }
                    }
                }
                i++
                checkSend()
        }
        if (! cards) {
            window.cards = knownCards
        }
        window.o = 0
        window.finished = 0
        window.download = true
        var downloadSuccess = false
        window.characterAmount = 0
        if (document.getElementById("findUnknownCards").checked || document.getElementById('onlyDownloadUnknown').checked) {
            window.cards = { }
            cards.idolized = [ ] 
            cards.nonidolized = [ ]
            for (var t=0; t<chars.length; t++) {
                if (chars[t][0].substring(0, 8) == 'idolized') {
                    var name = chars[t][0]
                    for (var y=0; y<totalCards; y++) {
                        if (knownCards[name].includes(y)) {
                            cards.idolized.push(y)
                        }
                    }
                    
                } else {
                    var name = chars[t][0]
                    for (var y=0; y<totalCards; y++) {
                        if (knownCards[name].includes(y)) {
                            cards.nonidolized.push(y)
                        }
                    }
                }
                
            }
            for (var u=0; u<totalCards; u++) {
                if (! cards.idolized.includes(u) && document.getElementById("findUnknownCards").checked) {
                    var p = document.createElement('li')
                    p.innerHTML = 'Missing card idolized '+u
                    cardList.appendChild(p)
                }
            }
            for (var u=0; u<totalCards; u++) {
                if (! cards.nonidolized.includes(u) && document.getElementById("findUnknownCards").checked) {
                    var p = document.createElement('li')
                    p.innerHTML = 'Missing card non-idolized '+u
                    cardList.appendChild(p)
                }
            }
            scanPrc.innerHTML = 'Finished!'
            var p = document.createElement('li')
            var m = cards
            var u = { }
            for (var t=0; t<chars.length; t++) {
                u[chars[t][0]] = [ ]
                if (chars[t][0].substring(0, 8) == 'idolized') {
                    for (var a=0; a<totalCards; a++) {
                        if (! cards.idolized.includes(a)) {
                            u[chars[t][0]].push(a)
                        }
                    }
                } else {
                    for (var a=0; a<totalCards; a++) {
                        if (! cards.nonidolized.includes(a)) {
                            u[chars[t][0]].push(a)
                        }
                    }
                }
            }
            if (document.getElementById("findUnknownCards").checked) {
                var blob = new Blob([JSON.stringify(u, null, 2)], {type : 'application/json'})
                 p.innerHTML = '<a href="'+URL.createObjectURL(blob)+'" target="_blank">Missing card list</a>'
                 cardList.appendChild(p)
                 return
            } else {
                window.knownCards = u
                window.cards = u
            }
        }
        for (var t=0; t<chars.length; t++) {
            if (! cards[chars[t][0]]) {
                cards[chars[t][0]] = [ ]
            }
            var toDownload = false
            if (chars[t][0].substring(0, 8) == 'idolized') {
                var idolName = chars[t][0].substring(8, chars[t][0].length)
                if (document.getElementById('idolized').checked) {
                    var toDownload = true
                }
            } else {
                var idolName = chars[t][0]
                if (document.getElementById('non-idolized').checked) {
                    var toDownload = true
                }
            }
            if (document.getElementById(idolName) && toDownload) {
                if (document.getElementById(idolName).checked || document.getElementById("downloadAll").checked || document.getElementById("noDownloadOther").checked) {
                    if (idolName == 'Transparent') {
                        if (document.getElementById('Transparent').checked) {
                            downloadSuccess = true
                            if (document.getElementById('downloadZip').checked) {
                                var groupFolder = zip.folder(chars[t][1])
                                var folder = groupFolder.folder(idolName)
                            } else {
                                var folder = false
                            }
                            startDownload(chars[t][0], folder)
                            characterAmount++
                        }
                    } else {
                        downloadSuccess = true
                        if (document.getElementById('downloadZip').checked) {
                            var groupFolder = zip.folder(chars[t][1])
                            var folder = groupFolder.folder(idolName)
                        } else {
                            var folder = false
                        }
                        startDownload(chars[t][0], folder)
                        characterAmount++
                    }
                }
            } else if ((document.getElementById("otherIdols").checked || document.getElementById("downloadAll").checked) && ! document.getElementById("noDownloadOther").checked && toDownload) {
                downloadSuccess = true
                if (document.getElementById('downloadZip').checked) {
                    var groupFolder = zip.folder(chars[t][1])
                    var folder = groupFolder.folder(idolName)
                } else {
                    var folder = false
                }
                startDownload(chars[t][0], folder)
                characterAmount++
            }
        }
        if (!downloadSuccess) {
            alert('Please select someone to download')
            window.download = false
            window.location.reload()
            return
        }
        counting.innerHTML = 'Amount Downloaded: 0'
        title.innerHTML = 'Amount Downloaded: 0'
        scanPrc.innerHTML = '0/'+characterAmount+' idols downloaded.'
    }
    function setscreensize() {
        var width = window.innerWidth
        var height = window.innerHeight
        if (width < 700) {
            var style = ''
            document.getElementById('Nijigasaki').style = style
            document.getElementById('Muse').style = style
            document.getElementById('Aqours').style = style
            document.getElementById('whitespace').style = style
        } else {
            var style = 'float:left; width:25%;'
            document.getElementById('Nijigasaki').style = style
            document.getElementById('Muse').style = style
            document.getElementById('Aqours').style = style
            document.getElementById('whitespace').style = style
        }
    }
    window.onload = function() {
        setscreensize()
        cardsVisibility()
    }
    window.addEventListener('beforeunload', function (e) {
        if (window.download) {
            e.preventDefault() 
            e.returnValue = ''
            return ''
        } else {
            return
        }
    })
    window.onresize = setscreensize
    </script>
</body>
</html>
