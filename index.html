<html>
<head>
	<title id='title'>Download sif cards from schoolido.lu</title>
	<script src='jszip.min.js'></script>
	<script src='FileSaver.js'></script>
</head>
<body>
	<button id='buttno' onclick='downloadImages()'>Download</button>
	<br><br><br>
	<p id='counting'></p>
	<br>
	<p id='scanPrc'></p>
	<br>
	<div id='settings'>
		<p>Start at </p><input id="startAt" type='number' value='0'>
		<p>End At</p><input id="totalCards" type='number' value='2817'><br><br>
		<input type="checkbox" id="developer" name="developer" value="developer">
		<label for="developer">Developer Mode</label><br>
		<input type="checkbox" id="deepScan" name="deepScan" value="deepScan">
		<label for="deepScan">Don't use list of known cards (Not recommended)</label><br>
	</div><br>
	<button onclick='zipFile()' id='zippFilee' style='display:none'>Stop Downloading and zip</button>
	<br><br>
	<ul id='cards'></ul>
	<script>
		var cardList = document.getElementById('cards')
		var counting = document.getElementById('counting')
		var scanPrc = document.getElementById('scanPrc')
		var title = document.getElementById('title')
		fetch('knownCards.json').then( function(response) {
			if (response.status == 200) {
				response.blob().then( function(blob){
					var reader = new FileReader()
					reader.onload = function(e) {
						try {
							window.knownCards = JSON.parse(e.target.result)
						} catch(e) {
							var p = document.createElement('h1')
							p.innerHTML = 'Json Parse Error of cards list'
							cardList.appendChild(p)
							document.getElementById('settings').style = 'display:none'
							document.getElementById('buttno').remove()
						}
					}
					reader.readAsText(blob)
				})
			}
		})
		function zipFile() {
			document.getElementById('zippFilee').style = 'display:none'
			window.download = false
			if (document.getElementById('developer').checked) {
				var p = document.createElement('li')
				var blob = new Blob([JSON.stringify(cards)], {type : 'application/json'})
				p.innerHTML = '<a href="'+URL.createObjectURL(blob)+'" target="_blank">card list</a>'
				cardList.appendChild(p)
			}
			scanPrc.innerHTML = 'Generating Zip'
			zip.generateAsync({type:"blob", comment: "Downloaded with https://ethanaobrien.github.io/sif-card-downloader/index.html"}, function updateCallback(metadata) {
				scanPrc.innerHTML = "Zipping File: " + metadata.percent.toFixed(2) + " %"
			}).then(function(content) {
				saveAs(content, "Anime Cards.zip")
				scanPrc.innerHTML = 'zip file downloaded - DO NOT CLOSE THIS PAGE until the download completes or you will need to repeat this entire process'
			})
		}
	function downloadImages(name) {
		var totalCards = 2817
		if (document.getElementById('totalCards').value && document.getElementById('totalCards').value != '') {
			var totalCards = document.getElementById('totalCards').value
		}
		window.chars = [
						["idolizedEli", "Muse"],
						["Eli", "Muse"],
						["idolizedHanayo", "Muse"],
						["Hanayo", "Muse"],
						["idolizedHonoka", "Muse"],
						["Honoka", "Muse"],
						["idolizedKotori", "Muse"],
						["Kotori", "Muse"],
						["idolizedMaki", "Muse"],
						["Maki", "Muse"],
						["idolizedNico", "Muse"],
						["Nico", "Muse"],
						["idolizedNozomi", "Muse"],
						["Nozomi", "Muse"],
						["idolizedRin", "Muse"],
						["Rin", "Muse"],
						["idolizedUmi", "Muse"],
						["Umi", "Muse"],
						["idolizedChika", "Aqours"],
						["Chika", "Aqours"],
						["idolizedHanamaru", "Aqours"],
						["Hanamaru", "Aqours"],
						["idolizedDia", "Aqours"],
						["Dia", "Aqours"],
						["idolizedKanan", "Aqours"],
						["Kanan", "Aqours"],
						["idolizedMari", "Aqours"],
						["Mari", "Aqours"],
						["idolizedRiko", "Aqours"],
						["Riko", "Aqours"],
						["idolizedRuby", "Aqours"],
						["Ruby", "Aqours"],
						["idolizedYoshiko", "Aqours"],
						["Yoshiko", "Aqours"],
						["idolizedYou", "Aqours"],
						["You", "Aqours"],
						["idolizedAi", "Nijigasaki"],
						["Ai", "Nijigasaki"],
						["idolizedAyumu", "Nijigasaki"],
						["Ayumu", "Nijigasaki"],
						["idolizedEmma", "Nijigasaki"],
						["Emma", "Nijigasaki"],
						["idolizedKanata", "Nijigasaki"],
						["Kanata", "Nijigasaki"],
						["idolizedKarin", "Nijigasaki"],
						["Karin", "Nijigasaki"],
						["idolizedKasumi", "Nijigasaki"],
						["Kasumi", "Nijigasaki"],
						["idolizedRina", "Nijigasaki"],
						["Rina", "Nijigasaki"],
						["idolizedSetsuna", "Nijigasaki"],
						["Setsuna", "Nijigasaki"],
						["idolizedShizuku", "Nijigasaki"],
						["Shizuku", "Nijigasaki"]
					]
			// need to add Nijigasaki
		var m = new JSZip()
		window.zip = m
		var cardList = document.getElementById('cards')
		var counting = document.getElementById('counting')
		var scanPrc = document.getElementById('scanPrc')
		var title = document.getElementById('title')
		document.getElementById('settings').style = 'display:none'
		document.getElementById('zippFilee').style = 'display:block'
		document.getElementById('buttno').remove()
		while (document.getElementById('cards').firstChild) {
			document.getElementById('cards').removeChild(document.getElementById('cards').firstChild);
		}
		function Download(name, t) {
				var i=0
				if (document.getElementById('startAt').value) {
					var i = document.getElementById('startAt').value
				}
				function checkSend() {
					if (! download) {
						return
					}
					if (knownCards[name].includes(i) || document.getElementById('deepScan').checked) {
						fetch('https://i.schoolido.lu/c/'+i+name+'.png').then(response => {
							if (response.status == 200) {
								response.blob().then(blob => {
									var p = document.createElement('li')
									p.innerHTML = '<a href="'+URL.createObjectURL(blob)+'" target="_blank">'+i+name+'.png</a>'
									cardList.appendChild(p)
									cards[name].push(i)
									t.file(i+name+'.png', blob);
									if (i != totalCards) {
										i++
										checkSend()
									} else {
										finished++
										scanPrc.innerHTML = finished+'/'+chars.length+' downloaded.'
										if (finished == chars.length) {
											zipFile()
										}
									}
								})
								o++
								counting.innerHTML = 'Amount Downloaded: '+o
								title.innerHTML = 'Amount Downloaded: '+o
							} else {
								if (i != totalCards) {
									i++
									checkSend()
								} else {
									finished++
									scanPrc.innerHTML = finished+'/'+chars.length+' downloaded.'
								if (finished == chars.length) {
									zipFile()
								}
								}
							}
						})
					} else {
						if (i != totalCards) {
							i++
							checkSend()
						} else {
							finished++
							scanPrc.innerHTML = finished+'/'+chars.length+' downloaded.'
							if (finished == chars.length) {
								zipFile()
							}
						}
					}
				}
				i++
				checkSend()
		}
		window.cards = { }
		window.o = 0
		window.download = true
		window.finished = 0
		for (var t=0; t<chars.length; t++) {
			cards[chars[t][0]] = [ ]
			console.log(chars[t][0])
			if (chars[t][0].substring(0, 8) == 'idolized') {
				var a = chars[t][0].substring(8, chars[t][0].length)
			} else {
				var a = chars[t][0]
			}
			var groupFolder = zip.folder(chars[t][1])
			var folder = groupFolder.folder(a)
			Download(chars[t][0], folder)
		}
	}
	</script>
</body>
</html>
